<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Avocado by cbmi</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1 class="header">Avocado</h1>
        <p class="header">Metadata APIs for Django</p>

        <ul>
          <li class="download"><a class="buttons" href="https://github.com/cbmi/avocado/zipball/master">Download ZIP</a></li>
          <li class="download"><a class="buttons" href="https://github.com/cbmi/avocado/tarball/master">Download TAR</a></li>
          <li><a class="buttons github" href="https://github.com/cbmi/avocado">View On GitHub</a></li>
        </ul>

        <p class="header">This project is maintained by <a class="header name" href="https://github.com/cbmi">cbmi</a></p>


      </header>
      <section>
        <h1>Avocado</h1>

<h4>Metadata APIs for Django</h4>

<h2>Target Audience</h2>

<p><strong>Developers who are interested in letting their data do the work for them.</strong></p>

<h4>Before you begin:</h4>

<ul>
<li>Some general Python experience is necessary.</li>
<li>Some experience with Django is necessary. If you are unfamiliar with Django, the <a href="https://docs.djangoproject.com/en/1.4/intro/tutorial01/">tutorial</a> is an excellent place to start, or you can look into the <a href="https://docs.djangoproject.com/en/1.4/topics/db/models/">model docs</a>. </li>
</ul><h2>Background</h2>

<p>Django models provides the <strong>structural</strong> metadata necessary for interfacing with the supported database backends. However, in general, there is no formal mechanism to supply <strong>descriptive</strong> or <strong>administrative</strong> metadata about your data model. Avocado is a Django app which provides easy metadata management for your models.</p>

<p>Avocado grew out of projects developed in a clinical research environment, where data models are frequently very large and complex. Additionally in this setting, there are data fields that contain related but decoupled data. This typically results in a large hierarchical data model, which can get pretty messy pretty quickly.</p>

<p>When developing applications that make use of this type of data, developers need to be able to provide end-users with appropriate context and representation of the data elements to avoid confusion and errors of omission.</p>

<h3>A Real Example</h3>

<p>All this abstract talk can be a bit confusing, so lets jump into an example. In medicine, it's typical that results from a diagnostic test like a blood test might be broken into several columns in a relational database: a numerical value, units of measure, and an assessment as to whether it is normal, high, or low. As a developer you'd like to be able to bundle these conveniently in your application.</p>

<p>While you could just store them all as one text field in your database, that sacrifices the ability to query and perform mathematical calculations on the numerical field. On the other hand, splitting them apart means a user who does not know your data model very well needs to know upfront to hunt down the various elements on their own, or they risk getting an incomplete picture of the retrieved data.</p>

<p>In many cases, these kinds of complexities result in a research workflow where the technical team act as "keepers of the data", and all the researcher's questions are filtered through them to be translated into queries. This situation, while good for the continued employment of engineers, is not ideal for open-ended discovery and hypothesis generation by researchers.</p>

<h3>The Solution</h3>

<p>Avocado was designed to support the development of accessible, transparent, and data-rich applications by providing several capabilities:</p>

<ul>
<li>A formal way to store additional metadata for your data model</li>
<li>Robust API's for interrogating metadata for dynamic query generation which includes translation, validation, cleaning, and execution of queries</li>
<li>Built-in extensible components for the formatting and exporting of data</li>
</ul><p>The power of Avocado's dynamic query generation lies in it's ability to <a href="#relationships-are-transparent">span relationships transparently</a>. This allows users (and to some extent developers) to focus on the data and not have to worry about the data model.</p>

<h3>Target Applications</h3>

<p>While Avocado can be useful for any project, it is most likely applicable to projects with a heavy focus on data. As a developer, it can be very useful as a tool for <em>accessing</em> some data for the first time. For users, it is most useful for applications focused on domain-specific data discovery.</p>

<h3>Types of Metadata</h3>

<h4>Structural</h4>

<p>Django's model field reference describes the options available for defining model fields. The field's subclass (e.g. <code>IntegerField</code>) and the various options passed (e.g. <code>null=True</code>) contain structural metadata which can be used to understand a field's constraints.</p>

<p>A simple example of how this is useful is to look at how Django's field validation works. If one attempts to save an integer field with a string value, a <code>ValidationError</code> will be thrown complaining about the type. This prevents a downstream database type error.</p>

<p>These constraints facilitate better representation of data fields by providing more context to users. This utlimately reduces the number of assumptions and guesswork required to understand what operations can be performed on the data.</p>

<p>Structural metadata tells the user what type of data should be stored in a model field, along with what types of operations can be performed on the data. Structural metadata only changes when the structure of the database itself is changed.</p>

<h4>Descriptive</h4>

<p>For any medium to large size data model, describing and managing each field can be a painstaking task. Fields and data available to end-users for query and representation purposes should be informative. This requires high-quality, descriptive metadata.</p>

<p>Django provides two field options <a href="https://docs.djangoproject.com/en/1.4/ref/models/options/#verbose-name"><code>verbose_name</code></a> and <a href="https://docs.djangoproject.com/en/1.4/ref/models/options/#help-text"><code>help_text</code></a> that are descriptive metadata, but are hard-coded in the field definition. This is a limitation if the metadata is managed by another party (client or domain expert) since this must be defined in the code itself.</p>

<p>Avocado provides numerous descriptive fields that enables better defined data fields.</p>

<h4>Administrative</h4>

<p>For applications which integrate multiple data sources, it can be useful to keep track of the various source information such as the data's organization, a Uniform Resource Identifier (URI), and access permissions.</p>

<p>Avocado has support for Django's built-in <a href="https://docs.djangoproject.com/en/1.4/ref/contrib/sites/">sites</a> and <a href="https://docs.djangoproject.com/en/1.4/topics/auth/#permissions">auth</a> apps enabling course grain (per-site/deployment) and fine grain (per-user) permissions on viewing and modifying data fields.</p>

<hr><h2>Prerequisites</h2>

<p>As of now, Python 2.7 is required. Want older versions supported? Fork the repo and submit a pull request.</p>

<p>To install Avocado and it's dependencies, it is assumed you have the latest versions of <a href="http://pypi.python.org/pypi/distribute">distribute</a> (or <a href="http://pypi.python.org/pypi/setuptools">setuptools</a>) and <a href="http://pypi.python.org/pypi/pip">Pip</a> installed.</p>

<h2>Install</h2>

<pre><code>pip install avocado
</code></pre>

<p>The <em>hard</em> dependencies which will auto-install are <a href="https://www.djangoproject.com">Django 1.4+</a>, <a href="http://pypi.python.org/pypi/modeltree">modeltree 1.0+</a> and <a href="https://github.com/bradjasper/django-jsonfield/">django-jsonfield 0.9+</a>.</p>

<h2>Optional Dependencies</h2>

<p>For a bare-bones Avocado installation the following dependencies may be skipped, but peruse through to understand the purpose of each one listed.</p>

<p><em>Have a suggestion for additional metadata integration? <a href="https://github.com/cbmi/avocado/issues/new">File an issue</a> on Avocado's GitHub repo.</em></p>

<h4><a href="https://docs.djangoproject.com/en/1.4/ref/contrib/sites/">Django "sites" Framework</a></h4>

<p>Having this installed enables associating <code>DataField</code>s and/or <code>DataConcept</code>s to specific sites, or more specifically, deployments. For example, an internal and external deployment may exist for the same application, but only the internal deployment provides access to certain <em>restricted</em> fields for operational use.</p>

<p>Install by adding <code>django.contrib.sites</code> to <code>INSTALLED_APPS</code>.</p>

<h4><a href="http://packages.python.org/django-guardian/">django-guardian</a></h4>

<p>This enables fine-grain control over who has permissions for various <code>DataField</code>s. Permissions can be defined at a user or <em>group</em> level.</p>

<p>Install by doing <code>pip install django-guardian</code> and adding <code>guardian</code> to <code>INSTALLED_APPS</code>.</p>

<h4><a href="http://haystacksearch.org">django-haystack</a></h4>

<p>What's having all this great descriptive data if no one can find it? Haystack provides search engine facilities for the metadata.</p>

<p>Install by doing <code>pip install django-haystack</code> and installing one of the supported search engine backends. The easiest to setup is <a href="http://pypi.python.org/pypi/Whoosh">Whoosh</a> which is implemented in pure Python. Install it by doing <code>pip install whoosh</code>. Add <code>haystack</code> to <code>INSTALLED_APPS</code>.</p>

<h4><a href="http://www.scipy.org">SciPy</a></h4>

<p>Avocado comes with a <code>stats</code> package for performing some rudimentary statistical, aggregation and clustering operations on the data. This is not always required or necessary for all data, but if there is a heavy emphasis on numerical data or the amount of data is quite large, the <code>stats</code> may come in handy.</p>

<p>Install by doing <code>pip install numpy</code> first (a dependency of SciPy), followed by <code>pip install scipy</code>. Note, there are a few dependencies for compilation, so review <a href="http://www.scipy.org/Installing_SciPy">SciPy's installation instructions</a> for more details.</p>

<h4><a href="http://packages.python.org/openpyxl/">openpyxl</a></h4>

<p>Avocado comes with an <code>export</code> package for supporting various means of exporting data into different formats. One of those formats is the native Microsoft Excel <em>.xlsx</em> format. To support that, the openpyxl library is used.</p>

<p>Install by doing <code>pip install openpyxl</code>.</p>

<h2>Configure</h2>

<p>At a minimum, your <code>INSTALLED_APPS</code> should contain the following apps:</p>

<div class="highlight"><pre><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">'django.contrib.admin'</span><span class="p">,</span>
    <span class="s">'django.contrib.auth'</span><span class="p">,</span>
    <span class="s">'django.contrib.contenttypes'</span><span class="p">,</span>
    <span class="s">'django.contrib.messages'</span><span class="p">,</span>
    <span class="s">'django.contrib.sessions'</span><span class="p">,</span>
    <span class="s">'django.contrib.sites'</span><span class="p">,</span>

    <span class="s">'avocado'</span><span class="p">,</span>
    <span class="o">...</span>
<span class="p">)</span>
</pre></div>

<hr><h2>Getting Started</h2>

<p>To introduce the API, we are going to get started with two example models, <code>Author</code> and <code>Book</code> in an app named <code>library</code>.</p>

<div class="highlight"><pre><span class="c"># library/models.py</span>
<span class="k">class</span> <span class="nc">Author</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Book</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">author</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Author</span><span class="p">)</span>
    <span class="n">pub_date</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateField</span><span class="p">(</span><span class="s">'publication date'</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">price</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DecimalField</span><span class="p">(</span><span class="s">'Book price'</span><span class="p">,</span> <span class="n">decimal_places</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

<h3>Bootstrap the Metadata</h3>

<p>To reiterate the introduction above, Avocado is about defining metadata and making use of existing metadata surrounding your data model.</p>

<p>Avocado comes with a <code>init</code> subcommand which introspects Django models and creates <code>DataField</code> instances representing the model fields. At least one app label (<code>library</code>) or model label (<code>library.book</code>) must be specified.</p>

<p>By default, <code>DataField</code> instances are not created for primary and foreign key fields. In practice, surrogate key fields are used infrequently as is, thus they are not created by default. To override this behavior and include key fields, add the flag <code>--include-keys</code>.</p>

<p>Likewise, model fields may be marked as not being editable in the model field definitions. This flag is turned on typically for operational or bookkeeping fields such as timestamps. By default, <code>DataField</code> instances are not created for these either, but can be overridden by passing the <code>--include-non-editable</code>.</p>

<div class="highlight"><pre>./manage.py avocado init library
1 field added <span class="k">for </span>Author
2 fields added <span class="k">for </span>Book
</pre></div>

<p><strong>Note:</strong> The <code>avocado</code> command acts as a parent for various subcommands. Simply type <code>./manage.py avocado</code> to show a list of available subcommands.</p>

<h3>DataField API</h3>

<p>An Avocado <code>DataField</code> instance represents a single Django model field instance. These three attributes uniquely identify a model field.</p>

<ul>
<li>
<code>f.field_name</code> - The name of the field on the model</li>
<li>
<code>f.model_name</code> - The name of the model this field is defined for</li>
<li>
<code>f.app_name</code> - The name of the app this field's model is defined in</li>
</ul><div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">avocado.models</span> <span class="kn">import</span> <span class="n">DataField</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">DataField</span><span class="p">(</span><span class="n">field_name</span><span class="o">=</span><span class="s">'title'</span><span class="p">,</span> <span class="n">model_name</span><span class="o">=</span><span class="s">'book'</span><span class="p">,</span> <span class="n">app_name</span><span class="o">=</span><span class="s">'library'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">f</span>
<span class="o">&lt;</span><span class="n">DataField</span> <span class="s">'library.book.title'</span><span class="o">&gt;</span>
</pre></div>

<p>These three attributes allow you to access the actual field instance and model class:</p>

<ul>
<li>
<code>f.field</code> - The model DataField instance this field represents</li>
<li>
<code>f.model</code> - The model class this field is associated with</li>
</ul><div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">f</span><span class="o">.</span><span class="n">field</span>
<span class="o">&lt;</span><span class="n">django</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">CharField</span> <span class="n">at</span> <span class="mh">0x101b5fe10</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">f</span><span class="o">.</span><span class="n">model</span>
<span class="o">&lt;</span><span class="k">class</span> <span class="err">'</span><span class="nc">library</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Book</span><span class="s">'&gt;</span>
</pre></div>

<h4>Descriptors</h4>

<p>Additional metadata can be defined for this object to make it more useful to users. Define various <em>descriptors</em> to enhance meaning of a data field.</p>

<ul>
<li>
<code>f.name</code> - A verbose human-readable name of the field</li>
<li>
<code>f.name_plural</code> - The plural form of the verbose name. If not defined, an <em>s</em> will be appended to <code>f.name</code> when the plural form is accessed provided <code>f.name</code> does not already end with <em>s</em>.</li>
<li>
<code>f.description</code> - A long description for the field</li>
<li>
<code>f.keywords</code> - Other related keywords (this is primarily applicable for search indexing by <a href="#django-haystack">django-haystack</a>)</li>
<li>
<code>f.unit</code> - The unit of the data, for example <em>gram</em>
</li>
<li>
<code>f.unit_plural</code> - The plural form of the unit, for example <em>grams</em>. If not defined, an <em>s</em> will be appended to <code>f.unit</code> when the plural form is accessed, provided <code>f.unit</code> does not already end with <em>s</em>.</li>
</ul><div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">'Price'</span>
<span class="c"># f.name_plural can be set, but does not need to be since</span>
<span class="c"># this is a simple plural form</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">f</span><span class="o">.</span><span class="n">get_plural_name</span><span class="p">()</span>
<span class="s">'Prices'</span>
<span class="c"># likewise with the f.unit_plural..</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">f</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s">'dollar'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">f</span><span class="o">.</span><span class="n">get_plural_unit</span><span class="p">()</span>
<span class="s">'dollars'</span>
</pre></div>

<h4>Properties</h4>

<p>A <code>DataField</code> also acts as an interface that exposes various properties and methods for directly accessing the underlying data or properties about the data.</p>

<h5>Editable</h5>

<ul>
<li>
<code>f.enumerable</code> - A flag denoting if the field's data is composed of an enumerable set. During a <a href="avocado-init">init</a>, each field's data is evaluated based on the internal type and the size of the data (number of distinct values). By default, if the field is a <code>CharField</code> and has <code>ENUMERABLE_MAXIMUM</code> or less distinct values, this will be set to <code>True</code>. </li>
</ul><h5>Read-only</h5>

<ul>
<li>
<code>f.internal_type</code> - The low-level datatype of the field. This is really only used for mapping to the <code>simple_type</code>, displayed below. Read more about the <a href="#internal-vs-simple-types">internal vs. simple types</a>.</li>
<li>
<code>f.simple_type</code> - The high-level datatype of the field used for validation purposes and as general metadata for client applications. (These types can be overridden, <a href="SIMPLE_TYPE_MAP">read about</a> the <code>SIMPLE_TYPE_MAP</code> setting)</li>
<li>
<code>f.size</code> - Returns the number of <em>distinct</em> values for this field</li>
<li>
<code>f.values_list</code> - Returns a <code>ValuesQuerySet</code> of distinct values for the field.
This is primarily used by the functions below. Useful when you want to apply additional QuerySet operations.</li>
<li>
<code>f.values</code> - Returns a tuple of distinct raw values ordered by the field. If the corresponding model is a subclass of Avocado's <code>Lexicon</code> abstract model, the order corresponds to the <code>order</code> field on the <code>Lexicon</code> model subclass. Read more about the <a href="#lexicon-abstract-class"><code>Lexicon</code> abstract class</a>.</li>
<li>
<code>f.labels</code> - Returns a unicoded tuple of labels. If the corresponding model is a subclass of Avocado's <code>Lexicon</code> abstract model, this corresponds to the <code>label</code> field on the <code>Lexicon</code> model subclass. Read more about the <a href="#lexicon-abstract-class"><code>Lexicon</code> abstract class</a>.</li>
<li>
<code>f.choices</code> - A tuple of pairs zipped from <code>f.values</code> and <code>f.labels</code>. This is useful for populating form fields for client applications.</li>
<li>
<code>f.searchable</code> (DEPRECATED) - A flag denoting if the field's data should be treated as searchable text. This applies to <code>TextField</code>s and <code>CharField</code>s which are not marked as <code>enumerable</code>.</li>
</ul><div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">f</span><span class="o">.</span><span class="n">internal_type</span>
<span class="s">'char'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">f</span><span class="o">.</span><span class="n">simple_type</span>
<span class="s">'string'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">f</span><span class="o">.</span><span class="n">size</span>
<span class="mi">33</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">f</span><span class="o">.</span><span class="n">values</span>
<span class="p">(</span><span class="s">'A Christmas Carol'</span><span class="p">,</span> <span class="s">'A Tale of Two Cities'</span><span class="p">,</span> <span class="s">'The Adventures of Oliver Twist'</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">f</span><span class="o">.</span><span class="n">labels</span>
<span class="p">(</span><span class="s">u'A Christmas Carol'</span><span class="p">,</span> <span class="s">u'A Tale of Two Cities'</span><span class="p">,</span> <span class="s">u'The Adventures of Oliver Twist'</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">f</span><span class="o">.</span><span class="n">choices</span>
<span class="p">((</span><span class="s">'A Christmas Carol'</span><span class="p">,</span> <span class="s">u'A Christmas Carol'</span><span class="p">),</span> <span class="o">...</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">f</span><span class="o">.</span><span class="n">values_list</span>
<span class="p">[</span><span class="s">'A Christmas Carol'</span><span class="p">,</span> <span class="s">'A Tale of Two Cities'</span><span class="p">,</span> <span class="s">'The Adventures of Oliver Twist'</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</pre></div>

<h5>Lexicon &amp; ObjectSet</h5>

<p>In addition to the above <code>DataField</code> API, instances that represent a 
<code>Lexicon</code> or <code>ObjectSet</code> class can utilize the <code>f.objects</code> property, normally
only available to <code>Model</code> classes. It will return a <code>QuerySet</code> of the model
it represents:</p>

<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">DataField</span><span class="p">(</span><span class="n">app_name</span><span class="o">=</span><span class="s">'dates'</span><span class="p">,</span> <span class="n">model_name</span><span class="o">=</span><span class="s">'month'</span><span class="p">,</span> <span class="n">field_name</span><span class="o">=</span><span class="s">'id'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">f</span><span class="o">.</span><span class="n">objects</span>
<span class="p">[</span><span class="o">&lt;</span><span class="n">Month</span><span class="p">:</span> <span class="s">'January'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">Month</span><span class="p">:</span> <span class="s">'February'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</pre></div>

<p>Read more about Lexicons and ObjectSets in the DataView API section below.</p>

<h4>Aggregation</h4>

<p>A simple, yet powerful set of methods are available for performing aggregations. Each method below returns an <code>Aggregator</code> object which enables chaining aggregations together as well as adding conditions to filter or exclude results.</p>

<p>By default, aggregations are table-wide. Zero or more lookups can be supplied to perform the aggregation relative to the fields in the <code>GROUP BY</code>.</p>

<ul>
<li>
<code>f.count([*groupby], distinct=False)</code> - Returns a count of all values for the field. If <code>distinct</code> is <code>True</code>, a <code>COUNT(DISTINCT foo)</code> will be performed.</li>
<li>
<code>f.max([*groupby])</code> - Returns the max value</li>
<li>
<code>f.min([*groupby])</code> - Returns the min value</li>
<li>
<code>f.avg([*groupby])</code> - Returns the average of all values</li>
<li>
<code>f.sum([*groupby])</code> - Returns the sum of all values</li>
<li>
<code>f.stddev([*groupby])</code> - Returns the standard deviation of all values. <em>This is not supported in SQLite by default.</em>
</li>
<li>
<code>f.variance([*groupby])</code> - Returns the variance of all values. <em>This is not supported in SQLite by default.</em>
</li>
</ul><p>Table-wide aggregations:</p>

<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">price</span> <span class="o">=</span> <span class="n">DataField</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_by_natural_key</span><span class="p">(</span><span class="s">'library'</span><span class="p">,</span> <span class="s">'book'</span><span class="p">,</span> <span class="s">'price'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">price</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="mi">33</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">price</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="mf">132.00</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">price</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
<span class="mf">14.50</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">price</span><span class="o">.</span><span class="n">avg</span><span class="p">()</span>
<span class="mf">32.25</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">price</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="mf">1064.25</span>
</pre></div>

<p>Each aggregation method can take Avocado or standard QuerySet lookup strings to group by those fields.</p>

<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">price</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s">'book__author'</span><span class="p">)</span>
<span class="p">[{</span><span class="s">'author'</span><span class="p">:</span> <span class="s">'Charles Dickens'</span><span class="p">,</span> <span class="s">'count'</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span> <span class="o">...</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">price</span><span class="o">.</span><span class="n">avg</span><span class="p">(</span><span class="s">'book__author'</span><span class="p">)</span>
<span class="p">[{</span><span class="s">'author'</span><span class="p">:</span> <span class="s">'Charles Dickens'</span><span class="p">,</span> <span class="s">'avg'</span><span class="p">:</span> <span class="mf">50.45</span><span class="p">},</span> <span class="o">...</span><span class="p">]</span>
</pre></div>

<p>The methods are chainable, the only caveat is that the <code>*groupby</code> arguments must be the same across all the aggregation methods. To bypass this, use the <code>groupby()</code> method to affix the group by fields.</p>

<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">price</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">avg</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="p">{</span><span class="s">'count'</span><span class="p">:</span> <span class="mi">33</span><span class="p">,</span> <span class="s">'avg'</span><span class="p">:</span> <span class="mf">32.25</span><span class="p">,</span> <span class="s">'sum'</span><span class="p">:</span> <span class="mf">1064.25</span><span class="p">}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">price</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'book__author'</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">avg</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="p">[{</span><span class="s">'author'</span><span class="p">:</span> <span class="s">'Charles Dickens'</span><span class="p">,</span> <span class="s">'count'</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s">'avg'</span><span class="p">:</span> <span class="mf">50.45</span><span class="p">,</span> <span class="s">'sum'</span><span class="p">:</span> <span class="mf">201.80</span><span class="p">},</span> <span class="o">...</span><span class="p">]</span>
</pre></div>

<p>Additional methods are available for filtering, excluding and ordering the data. Each aggregation that is chained is named after the aggregation applied. As shown below, the count aggregation can be used in the subsequent <code>filter</code> and <code>order_by</code> methods.</p>

<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">price</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s">'book__author'</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">count__gt</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">'count'</span><span class="p">)</span>
</pre></div>

<h3>Translators</h3>

<p>Translators are useful for converting values before querying the database. Say for instance that we want to be able to query our database based on a patient age, but we are only storing the patients date of birth. We can write a translator to convert the patient age to the appropriate birthdate to get the correct results from the query.</p>

<p>Translators are used to modify query conditions prior to being executed. Depending on the quality or variability of your data, the query interface for a field may not represent the data 1:1 with the underlying data. Thus the incoming query condition may need to be translated in some way to work with the underlying database.</p>

<p>These operator classes perform only light validation of the value to prevent being too restrictive.</p>

<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">avocado.query.operators</span> <span class="kn">import</span> <span class="n">registry</span> <span class="k">as</span> <span class="n">operators</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">iexact</span> <span class="o">=</span> <span class="n">operators</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'iexact'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">iexact</span><span class="o">.</span><span class="n">is_valid</span><span class="p">([</span><span class="s">'hello'</span><span class="p">,</span> <span class="s">'world'</span><span class="p">])</span>
<span class="bp">False</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">iexact</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="s">'hello world'</span><span class="p">)</span>
<span class="bp">True</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">inlist</span> <span class="o">=</span> <span class="n">operators</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'inlist'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">inlist</span><span class="o">.</span><span class="n">is_valid</span><span class="p">([</span><span class="s">'hello'</span><span class="p">,</span> <span class="s">'world'</span><span class="p">])</span>
<span class="bp">True</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">inlist</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="s">'hello world'</span><span class="p">)</span>
<span class="bp">False</span>
</pre></div>

<p>The base <code>Translator</code> class uses <a href="https://docs.djangoproject.com/en/1.4/ref/contrib/forms/api/">Django's Form API</a> to validate and clean the value relative to the underlying model field (e.g. <code>f.field</code>).</p>

<p>The primary method to call is <code>translate</code> which calls <code>clean_value</code> and <code>clean_operator</code>.</p>

<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">avocado.query.translators</span> <span class="kn">import</span> <span class="n">Translate</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">avocado.models</span> <span class="kn">import</span> <span class="n">DataField</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">DataField</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'library'</span><span class="p">,</span> <span class="s">'book'</span><span class="p">,</span> <span class="s">'title'</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">t</span> <span class="o">=</span> <span class="n">Translator</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">'icontains'</span><span class="p">,</span> <span class="s">'Python'</span><span class="p">)</span>
<span class="p">{</span>
    <span class="s">'id'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s">'operator'</span><span class="p">:</span> <span class="s">'icontains'</span><span class="p">,</span>
    <span class="s">'value'</span><span class="p">:</span> <span class="s">'Python'</span><span class="p">,</span>
    <span class="s">'cleaned_data'</span><span class="p">:{</span>
        <span class="s">'operator'</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">Operator</span><span class="p">:</span> <span class="s">"contains the text"</span> <span class="p">(</span><span class="n">icontains</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span>
        <span class="s">'value'</span><span class="p">:</span> <span class="s">u'Python'</span><span class="p">,</span>
        <span class="s">'language'</span><span class="p">:</span> <span class="s">u'Book title contains the text Python'</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="s">'query_modifiers'</span><span class="p">:{</span>
        <span class="s">'condition'</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">django</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">query_utils</span><span class="o">.</span><span class="n">Q</span> <span class="n">at</span> <span class="mh">0x1027b78d0</span><span class="o">&gt;</span><span class="p">,</span>
        <span class="s">'annotations'</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
        <span class="s">'extra'</span><span class="p">:</span> <span class="bp">None</span> 
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<h2>DataConcept API</h2>

<h3>Introduction</h3>

<p>As Avocado is a metadata management tool, it is important to note that metadata is most useful to end-users who can readily access it. More specifically, the metadata can be used to provide more context and meaning to the data and the data model, enabling end-users to get the most out of their data.</p>

<p>The notion of a <code>DataConcept</code> came from the need to represent discrete data in a readable, domain-specific way. Data, however, is typically stored in a normalized, discrete and efficient way, making it a bit difficult for users to fully understand. For example, sometimes a single <em>column</em> of data in a database table is meaningless without another column, such as a database storing medicine prescriptions with a column of <code>dose</code> without the columns of <code>unit</code> and <code>interval</code>. </p>

<p>Data must be stored in a discrete way to ensure the database can treat it properly and perform the correct operations on the data. Unfortunately, most users don't always know how their data is stored in the database; they are only interested in accessing their data in a way that makes sense to them and allows them to use their data in a meaningful way. <code>DataConcept</code>s help solve this problem.</p>

<p><code>DataConcept</code>s encapsulate one or more fields intended to be represented together in some way. This allows users to combine their fields in a way that makes the most sense for how they want to use their data given their current context. For example, we could create a <code>DataConcept</code> for dosage that would represent <code>dose</code>, <code>unit</code>, and <code>interval</code> together.</p>

<p>Here is an example showing how we would create a <code>DataConcept</code> called <code>Dosage</code> for our prescriptions database.</p>

<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">avocado.models</span> <span class="kn">import</span> <span class="n">DataConcept</span><span class="p">,</span> <span class="n">DataField</span><span class="p">,</span> <span class="n">DataConceptField</span>
<span class="c"># Create the 'Dosage' DataConcept which combines the 'dose'</span>
<span class="c"># 'unit', and 'interval' fields</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">concept</span> <span class="o">=</span> <span class="n">DataConcept</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'Dosage'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">concept</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

<span class="c"># Get the DataFields for the 'dose', 'unit', and 'interval'</span>
<span class="c"># fields</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">dose</span> <span class="o">=</span> <span class="n">DataField</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_by_natural_key</span><span class="p">(</span><span class="s">'models'</span><span class="p">,</span> <span class="s">'prescriptions'</span><span class="p">,</span> <span class="s">'dose'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">unit</span> <span class="o">=</span> <span class="n">DataField</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_by_natural_key</span><span class="p">(</span><span class="s">'models'</span><span class="p">,</span> <span class="s">'prescriptions'</span><span class="p">,</span> <span class="s">'unit'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">interval</span> <span class="o">=</span> <span class="n">DataField</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_by_natural_key</span><span class="p">(</span><span class="s">'models'</span><span class="p">,</span> <span class="s">'prescriptions'</span><span class="p">,</span> <span class="s">'interval'</span><span class="p">)</span>
<span class="c"># Recall, the DataFields are populated when you call </span>
<span class="c"># './manage.py avocado init'</span>

<span class="c"># Add the DataFields to the DataConcept</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">DataConceptField</span><span class="p">(</span><span class="n">concept</span><span class="o">=</span><span class="n">concept</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="n">dose</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">DataConceptField</span><span class="p">(</span><span class="n">concept</span><span class="o">=</span><span class="n">concept</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="n">unit</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">DataConceptField</span><span class="p">(</span><span class="n">concept</span><span class="o">=</span><span class="n">concept</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="n">interval</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>

<h3>Query Views</h3>

<h4>Datatypes</h4>

<p>Datatypes, in the context of Avocado, are used for representation of the data for querying, not for data entry. Differentiating between datatypes such as <code>int</code> vs. <code>float</code> are typically too specific for data discovery, thus these related native types are rolled up into a high-level datatype, such as <code>number</code>.</p>

<ul>
<li><code>string</code></li>
<li><code>number</code></li>
<li><code>date</code></li>
<li><code>boolean</code></li>
</ul><h3>Formatters</h3>

<p>The most common utility of the <code>DataConcept</code> abstraction is formatting the fields' data in a usable format for the consumer. The consumer may be a human, a Web browser, an R interpreter or anything else. Regardless of the consumer of the data, formatters provide an API for taking in raw data and outputting a representation of that data.</p>

<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">avocado.formatters</span> <span class="kn">import</span> <span class="n">Formatter</span>
<span class="c"># Get the 'Dosage' concept which combines the 'dose'</span>
<span class="c"># 'unit', and 'interval' fields</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">dosage</span> <span class="o">=</span> <span class="n">DataConcept</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'Dosage'</span><span class="p">)</span>
<span class="c"># Prepare a formatter for the dosage concept</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">formatter</span> <span class="o">=</span> <span class="n">Formatter</span><span class="p">(</span><span class="n">dosage</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="mi">60</span><span class="p">,</span> <span class="s">'mg'</span><span class="p">,</span> <span class="s">'as needed'</span><span class="p">]</span>
<span class="c"># Returns ['60', 'mg', 'as needed']</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">formatter</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">preferred_formats</span><span class="o">=</span><span class="p">[</span><span class="s">'string'</span><span class="p">])</span>

<span class="c"># The formatter can also be assigned</span>
</pre></div>

<p>A formatter attempts to solve two problems: </p>

<ul>
<li>Coerce the various values into the preferred format </li>
<li>Perform an operation on each or all of the values </li>
</ul><p>As shown above, the <code>formatter</code> instance is callable and takes a sequence of <code>values</code> and a <code>preferred_formats</code> argument. Since this is the base formatter class, it is only useful for coercing datatypes.</p>

<p>Formatters can be easily created by subclassing the base <code>Formatter</code> class and adding, overriding, or augmenting the methods. As stated above, a formatter can be applied to each raw value or all values together. As an example of this, we can create a simple <code>ConcatFormatter</code>.</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">ConcatFormatter</span><span class="p">(</span><span class="n">Formatter</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">cfields</span><span class="p">,</span> <span class="o">**</span><span class="n">context</span><span class="p">):</span>
        <span class="n">joined</span> <span class="o">=</span> <span class="s">' '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">super</span><span class="p">(</span><span class="n">ConcatFormatter</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
                <span class="n">values</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="k">return</span> <span class="n">OrderedDict</span><span class="p">({</span><span class="s">'output'</span><span class="p">:</span> <span class="n">joined</span><span class="p">})</span>

    <span class="c"># Informs the class this method can process multiple values at a time</span>
    <span class="n">to_string</span><span class="o">.</span><span class="n">process_multiple</span> <span class="o">=</span> <span class="bp">True</span>
</pre></div>

<h3>Exporters</h3>

<p>For data export support add <code>avocado.export</code> to <code>INSTALLED_APPS</code>.</p>

<p>Here is an example of the API:</p>

<div class="highlight"><pre><span class="kn">from</span> <span class="nn">avocado.export</span> <span class="kn">import</span> <span class="n">CSVExporter</span>

<span class="n">exporter</span> <span class="o">=</span> <span class="n">CSVExporter</span><span class="p">(</span><span class="n">concepts</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">exporter</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
</pre></div>

<p><code>rows</code> is an iterable of iterables (e.g. rows from a database query) that will
be chunked up and formatted by the <code>concepts</code>. Here is a ASCII visual:</p>

<pre><code>chunks:         |    c1   |      c2      | c3 |
row values:     | v1 | v2 | v3 | v4 | v5 | v6 |
</code></pre>

<p>The length of a chunk corresponds to the number of fields associated with a
concept. <code>c1</code> (the first two values) will be formatted by <code>concept1</code>'s
formatter, <code>c2</code> (next three values) with <code>concept2</code>, etc.</p>

<hr><h2>DataContext API</h2>

<p>Avocado defines a simple structure for representing query conditions. A query condition boils down to three components:</p>

<ul>
<li>the <code>datafield</code> to which the condition applies</li>
<li>the <code>operator</code> which defines how the condition is being applied</li>
<li>the <code>value</code> which defines which value(s) are affected by the condition</li>
</ul><p>Just as in a SQL statement, applying conditions to query enables constraining the data to some subset. Conditions can of course be combined using conditional AND or OR operators (not the same operators mentioned above). These conditional <em>branches</em> join together two or more conditions or other branches resulting in a <em>tree</em> of conditions.
DataContext</p>

<pre><code>     AND
    /   \
  OR     A
 /  \
B    C
</code></pre>

<p>Using <code>datafield</code>s as the condition's reference point enables applying the tree of conditions to any query.</p>

<p>The `` model provides a simple API for storing, persisting and applying the condition tree. In it's raw state, the condition tree is simply a combination of <em>condition</em> and <em>branch</em> nodes. Following this example, the schema of both node types are described.</p>

<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">avocado.models</span> <span class="kn">import</span> <span class="n">DataContext</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">cxt</span> <span class="o">=</span> <span class="n">DataContext</span><span class="p">()</span>
<span class="c"># This will be serialized (and validated) to JSON when saved</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">cxt</span><span class="o">.</span><span class="n">json</span> <span class="o">=</span> <span class="p">{</span><span class="s">'id'</span><span class="p">:</span> <span class="s">'library.book.price'</span><span class="p">,</span> <span class="s">'operator'</span><span class="p">:</span> <span class="s">'gt'</span><span class="p">,</span> <span class="s">'value'</span><span class="p">:</span> <span class="mf">10.00</span><span class="p">}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">queryset</span> <span class="o">=</span> <span class="n">cxt</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="nb">str</span><span class="p">(</span><span class="n">queryset</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>
<span class="s">'SELECT "book"."id", "book"."title", "book"."author_id", "book"."price" FROM "book" WHERE "book"."price" &gt; 10.00 '</span>
</pre></div>

<h4>Condition Node</h4>

<ul>
<li>
<code>id</code> - The value can be:

<ul>
<li>An <code>int</code> representing the primary key identifer for a <code>DataField</code> instance, e.g. <code>1</code>
</li>
<li>Period-delimited <code>string</code> representing a natural key for a <code>DataField</code> instance, e.g. <code>'app.model.field'</code>
</li>
<li>An <code>array</code> of strings representing a natural key for a <code>DataField</code> instance, e.g. <code>["app", "model", "field"]</code>
</li>
</ul>
</li>
<li>
<code>operator</code> - A <code>string</code> representing a valid <code>DataField</code> operator. Valid operators vary depending on the implementation and are validated downstream. If not specified, the operator defaults to <code>exact</code>.</li>
<li>
<code>value</code> - Any valid JSON data type.</li>
</ul><h4>Branch Node</h4>

<ul>
<li>
<code>type</code> - A <code>string</code> that is <code>"and"</code> or <code>"or"</code> representing the type of branch or logical operation between child nodes defined in the <code>children</code> property.</li>
<li>
<code>children</code> - An <code>array</code> of <em>two</em> or more nodes.

<ul>
<li><em>See example [DataContext Condition Trees]</em></li>
</ul>
</li>
</ul><hr><h2>DataView API</h2>

<hr><h2>Lexicon Abstract Class</h2>

<p>Avocado defines an abstract class named <code>Lexicon</code>. It is a common practice
when normalizing a data model to <em>break out</em> repeated finite sets of terms
within a column into their own table. This is quite obvious for entities such
as <em>books</em> and <em>authors</em>, but less so for commonly used or enumerable
terms.</p>

<pre><code>id | name | birth_month
---+------+------------
 1   Sue    May
 2   Joe    June
 3   Bo     Jan
 4   Jane   Apr
...
</code></pre>

<p>The above shows a table with three columns <code>id</code>, <code>name</code> and <code>birth_month</code>.
There are some inherent issues with <code>birth_month</code>:</p>

<ol>
<li>Months have an arbitrary order which makes it very difficult to order the
rows by <code>birth_month</code> since they are ordered lexicographically</li>
<li>As the table grows (think millions) the few bytes of disk space each
repeated string takes up starts having a significant impact</li>
<li>The cost of querying for the distinct months within the population gets
increasingly more expensive as the table grows</li>
<li>As the table grows, the cost of table scans increases since queries are
acting on strings rather than an integer (via a foreign key)</li>
</ol><p>Although the above example is somewhat contrived, the reasons behind this
type of normalization are apparent.</p>

<p>To implement, subclass and define the <code>value</code> and <code>label</code> fields.</p>

<div class="highlight"><pre><span class="kn">from</span> <span class="nn">avocado.lexicon.models</span> <span class="kn">import</span> <span class="n">Lexicon</span>

<span class="k">class</span> <span class="nc">Month</span><span class="p">(</span><span class="n">Lexicon</span><span class="p">):</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</pre></div>

<p>A few of the advantages include:</p>

<ul>
<li>define an arbitrary <code>order</code> of the items in the lexicon</li>
<li>define a integer <code>code</code> which is useful for downstream clients that
prefer working with a enumerable set of values such as SAS or R</li>
<li>define a verbose/more readable label for each item

<ul>
<li>For example map <em>Jan</em> to <em>January</em>
</li>
</ul>
</li>
</ul><p>In addition, Avocado treats Lexicon subclasses specially since it is such a
common practice to use them. They are used in the following ways:</p>

<ul>
<li>performing a <code>init</code> will ignore the <code>label</code>, <code>code</code>, and <code>order</code>
fields since they are supplementary to the <code>value</code> (you can of course add them
manually later)</li>
<li>the <code>DataField</code> that represents the <code>value</code> field on a Lexicon subclass will

<ul>
<li>use the <code>order</code> field whenever accessing values or when applied to a query</li>
<li>use the <code>label</code> field when accessing <code>f.labels</code>
</li>
<li>use the <code>code</code> field when accessing <code>f.codes</code>
</li>
</ul>
</li>
</ul><hr><h2>Object Sets</h2>

<p>It is common for saving off sets of objects (e.g. patients) for later reference. This enables performing actions to the set without the constraints of the query conditions as well as performing basic set operations such as union and intersection between sets of the same type.</p>

<p>The main benefits include:</p>

<ul>
<li>API for creating persistant, on-the-fly sets of objects (effectively materialized views)</li>
<li>Performance benefits of joining on a fixed set of a objects without the encumbrance of query conditions</li>
<li>Using sets as building blocks for creating more complicated queries that may be virtually impossible for end users to construct manually otherwise</li>
</ul><p>For models that need to be <em>set-enabled</em>, the model should subclass <code>ObjectSet</code> which will make it easier elsewhere to make use of such models. The subclass must implement a <code>ManyToManyField</code> pointing to the model of interest.</p>

<p>The usage should look like this:</p>

<div class="highlight"><pre><span class="kn">from</span> <span class="nn">avocado.sets</span> <span class="kn">import</span> <span class="n">ObjectSet</span><span class="p">,</span> <span class="n">SetObject</span>

<span class="k">class</span> <span class="nc">PatientSet</span><span class="p">(</span><span class="n">ObjectSet</span><span class="p">):</span>
    <span class="n">patients</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="n">Patient</span><span class="p">,</span> <span class="n">through</span><span class="o">=</span><span class="s">'PatientSetObject'</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">PatientSetObject</span><span class="p">(</span><span class="n">SetObject</span><span class="p">):</span>
    <span class="c"># The db_column overrides are certainly not necessary, but makes the</span>
    <span class="c"># column names a bit more readable when writing raw queries..</span>
    <span class="n">object_set</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">PatientSet</span><span class="p">,</span> <span class="n">db_column</span><span class="o">=</span><span class="s">'set_id'</span><span class="p">)</span>
    <span class="n">set_object</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Patient</span><span class="p">,</span> <span class="n">db_column</span><span class="o">=</span><span class="s">'object_id'</span><span class="p">)</span>
</pre></div>

<p>The main integration point is exposing sets as a means of filtering the object of interest. </p>

<ul>
<li>female patients</li>
<li>less than 5 years of age</li>
<li>who are in my "african americans with conductive hearing loss" set</li>
</ul><p>This translates to a <code>DataContext</code> that looks like this:</p>

<div class="highlight"><pre><span class="p">{</span>
    <span class="s2">"type"</span><span class="o">:</span> <span class="s2">"and"</span><span class="p">,</span>
    <span class="s2">"children"</span><span class="o">:</span> <span class="p">[{</span>
        <span class="s2">"id"</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="c1">// sex datafield</span>
        <span class="s2">"operator"</span><span class="o">:</span> <span class="s2">"exact"</span><span class="p">,</span>
        <span class="s2">"value"</span><span class="o">:</span> <span class="s2">"female"</span>
    <span class="p">},</span> <span class="p">{</span>
        <span class="s2">"id"</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="c1">// age datafield</span>
        <span class="s2">"operator"</span><span class="o">:</span> <span class="s2">"lt"</span>
        <span class="s2">"value"</span><span class="o">:</span> <span class="mi">5</span>
    <span class="p">},</span> <span class="p">{</span>
        <span class="s2">"id"</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span> <span class="c1">// patientset datafield</span>
        <span class="s2">"operator"</span><span class="o">:</span> <span class="s2">"exact"</span><span class="p">,</span>
        <span class="s2">"value"</span><span class="o">:</span> <span class="mi">30</span> <span class="c1">// patientset id</span>
    <span class="p">}]</span>
<span class="p">}</span>
</pre></div>

<p>Although it may be queried and exposed as querying on the set itself, the actually query being executed must join from <code>Patient</code> → <code>PatientSetObject</code> where <code>set_id = 30</code>. The translator must map from an <code>ObjectSet</code> subclass to it's respective M2M through model. The output SQL would look something like:</p>

<div class="highlight"><pre><span class="k">SELECT</span> <span class="p">...</span> <span class="k">some</span> <span class="n">columns</span> <span class="p">...</span>
<span class="k">FROM</span> <span class="ss">"patient"</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">"patientsetobject"</span> <span class="k">ON</span> <span class="p">(</span><span class="ss">"patient"</span><span class="p">.</span><span class="ss">"id"</span> <span class="o">=</span> <span class="ss">"patientsetobject"</span><span class="p">.</span><span class="ss">"object_id"</span><span class="p">)</span>
<span class="k">WHERE</span> <span class="ss">"patient"</span><span class="p">.</span><span class="ss">"sex"</span> <span class="o">=</span> <span class="s1">'female'</span> <span class="k">AND</span> <span class="ss">"patient"</span><span class="p">.</span><span class="ss">"age"</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="k">AND</span> <span class="ss">"patientsetobject"</span><span class="p">.</span><span class="ss">"set_id"</span> <span class="o">=</span> <span class="mi">30</span>
</pre></div>

<hr><h2>Template Tags</h2>

<p>Avocado provides single base templatetag (similar to the management commands). The syntax is as follows:</p>

<div class="highlight"><pre><span class="cp">{%</span> <span class="k">avocado</span> <span class="o">[</span><span class="nv">command</span><span class="o">]</span> <span class="o">[</span><span class="nv">arguments</span><span class="o">]</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>

<h3>Load</h3>

<p>Currently, the only avocado template tag command implemented is the <code>load</code> command for loading <code>DataField</code> and <code>DataConcept</code> instances on demand:</p>

<p><strong>DataField with primary key</strong></p>

<div class="highlight"><pre><span class="cp">{%</span> <span class="k">avocado</span> <span class="nv">load</span> <span class="nv">field</span> <span class="m">10</span> <span class="k">as</span> <span class="nv">foo</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>

<p><strong>DataField using a natural key</strong></p>

<div class="highlight"><pre><span class="cp">{%</span> <span class="k">avocado</span> <span class="nv">load</span> <span class="nv">field</span> <span class="s2">"app.model.field"</span> <span class="k">as</span> <span class="nv">foo</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>

<p><strong>DataConcept with a primary key</strong></p>

<div class="highlight"><pre><span class="cp">{%</span> <span class="k">avocado</span> <span class="nv">load</span> <span class="nv">concept</span> <span class="m">20</span> <span class="k">as</span> <span class="nv">foo</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>

<h4>Example</h4>

<p>This enables using the metadata dynamically in templates through the API, which is documented above.</p>

<div class="highlight"><pre><span class="cp">{%</span> <span class="k">avocado</span> <span class="nv">load</span> <span class="nv">field</span> <span class="s2">"library.author.name"</span> <span class="k">as</span> <span class="nv">author</span> <span class="cp">%}</span><span class="x"></span>

<span class="x">&lt;select name="authors"&gt;</span>
<span class="cp">{%</span> <span class="k">for</span> <span class="nv">value</span><span class="o">,</span> <span class="nv">label</span> <span class="nv">for</span> <span class="nv">author.choices</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">    &lt;option value="</span><span class="cp">{{</span> <span class="nv">value</span> <span class="cp">}}</span><span class="x">"&gt;</span><span class="cp">{{</span> <span class="nv">label</span> <span class="cp">}}</span><span class="x">&lt;/option&gt;</span>
<span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">&lt;/select&gt;</span>
</pre></div>

<hr><h2>Management Commands</h2>

<p>Avocado commands are namespaced under <code>avocado</code>. Execute <code>./bin/manage.py avocado</code> to view a list of available subcommands.</p>

<h3>init</h3>

<p>The init command creates <code>DataField</code> instances from Django model fields. This will be used whenever new models or new fields are added to your data model.</p>

<div class="highlight"><pre>./manage.py avocado init labels <span class="o">[</span>--force<span class="o">]</span> <span class="o">[</span>--include-keys<span class="o">]</span> <span class="o">[</span>--include-non-editable<span class="o">]</span>
</pre></div>

<p><strong>Parameters</strong></p>

<ul>
<li>
<code>labels</code> - refers to one or more space-separated app, model or field labels, for example library.book refers the the model Book in the app library.</li>
<li>
<code>--force</code> - forces an update to existing field instances (relative to the apps or models defined and overwrites any existing descriptive values such as name, name_plural, and description.</li>
<li>
<code>--include-non-editable</code> - creates field instance for model fields with editable=False (by default these are ignored).</li>
<li>
<code>--include-keys</code> - creates fields instances for primary and foreign key fields (by default these are ignored).</li>
</ul><h3>check</h3>

<p>Performs Avocado setup and optional dependency checks. It also checks for
<code>DataField</code> instances that no longer map to Django model fields
(like a dead hyperlink).</p>

<div class="highlight"><pre>./manage.py avocado check <span class="o">[</span>--output<span class="o">=</span>html<span class="o">]</span>
</pre></div>

<p><strong>Parameters</strong></p>

<p><code>--output</code> - Specify the output type of the report. Options are <code>html</code> or <code>stdout</code>.
Default is <code>stdout</code>.</p>

<h3>data</h3>

<p>Finds all models referenced by the app or model <code>labels</code> and updates data-related properties such as caches and pre-calculated values.</p>

<div class="highlight"><pre>./manage.py avocado data labels <span class="o">[</span>--modified<span class="o">]</span>
</pre></div>

<p><strong>Parameters</strong></p>

<ul>
<li>
<code>labels</code> - refers to one or more space-separated app, model, or field labels, for example library.book refers the the model Book in the app library.</li>
<li>
<code>--modified</code> - Updates the <code>data_modified</code> on <code>DataField</code> instances corresponding the labels. This is primarily used for cache invalidation.</li>
</ul><p><strong>Note, currently <code>--modified</code> is the only flag that does anything</strong></p>

<h3>cache</h3>

<p>Finds all models referenced by the app, model or field <code>labels</code> and explicitly updates various cached properties relative to the <code>data_modified</code> on <code>DataField</code> instances.</p>

<h3>history</h3>

<p>Tools for managing Avocado's exposed history API.</p>

<div class="highlight"><pre>./manage.py avocado <span class="nb">history</span> <span class="o">[</span>--prune<span class="o">]</span>
</pre></div>

<p><strong>Parameters</strong></p>

<ul>
<li>
<code>--prune</code> - Prunes the oldest archived objects based on the <code>HISTORY_ENABLED</code> and <code>HISTORY_MAX_SIZE</code> settings.</li>
</ul><h3>migration</h3>

<p>Create a metadata fixture and corresponding South data migration script for remote loading of metadata.</p>

<div class="highlight"><pre>./manage.py avocado migration <span class="o">[</span>migration_name<span class="o">]</span> <span class="o">[</span>fixture_name<span class="o">]</span> <span class="o">[</span>--no-fake<span class="o">]</span> <span class="o">[</span>--backup-path<span class="o">=</span>&lt;path&gt;<span class="o">]</span>
</pre></div>

<p><strong>Parameters</strong></p>

<ul>
<li>
<code>migration_name</code> - Custom name of the migration file. Defaults to "avocado_metadata_migration"</li>
<li>
<code>fixture_name</code> - Custom name of the fixture name. Defaults to "avocado_metadata"</li>
<li>
<code>--no-fake</code> - By default, new migrations created will be immediately <em>faked</em> by South since the data migration is derived from the same database. This flag will prevent the faked migration from happening (this is not recommeneded).</li>
<li>
<code>--backup-path=&lt;path&gt;</code> - When the migration executes, a metadata fixture is created of the target database immediately (and in the same transaction) prior to loading the new fixture. By default a temporary file is created, but this argument defines a specific file to write to. Note that depending on where the migration execution occurs (e.g. on a remote machine) the file path must be valid as well as have the correct permissions to writing to the file.</li>
</ul><h2>Settings</h2>

<p>Avocado settings are defined as a dictionary, named <code>AVOCADO</code>, with each key corresponding to a setting listed below:</p>

<div class="highlight"><pre><span class="n">AVOCADO</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'SIMPLE_TYPE_MAP'</span><span class="p">:</span> <span class="p">{</span> <span class="o">...</span> <span class="p">},</span>
    <span class="s">'ENUMERABLE_MAXIMUM'</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
    <span class="o">...</span>
<span class="p">}</span>
</pre></div>

<h3>SIMPLE_TYPE_MAP</h3>

<p><code>DataField</code> datatypes from Avocado's perspective are used purely as metadata for the purposes of making the underlying data accessible.</p>

<p>This setting is used to customize what is returned by the <code>f.simple_type</code> property. The default datatype comes from the internal datatype of a the model field's <code>get_internal_type()</code> method. Any of these default datatypes can be mapped to some other datatype.</p>

<p>Datatypes in this context should be simple, for example not differentiating between <code>int</code>, <code>float</code>, or <code>Decimal</code>. They are all just numbers, to that is the datatype.</p>

<p>These datatypes help define how input is validated and which operators are allowed.</p>

<h3>OPERATOR_MAP</h3>

<p>A mapping between the client-friendly datatypes and sensible operators
that will be used to validate a query condition. In many cases, these types
support more operators than what are defined, but are not include because
they are not commonly used.</p>

<h3>INTERNAL_TYPE_FORMFIELDS</h3>

<p>A general mapping of formfield overrides for all subclasses. the mapping is
similar to the SIMPLE_TYPE_MAP, but the values reference internal
formfield classes, that is integer -&gt; IntegerField. in many cases, the
validation performed may need to be a bit less restrictive than what the
is actually necessary</p>

<h3>ENUMERABLE_MAXIMUM</h3>

<p>The maximum number of distinct values allowed for setting the
<code>enumerable</code> flag on <code>DataField</code> instances during the <code>init</code> process. This
will only be applied to fields with non-text strings types and booleans</p>

<h3>HISTORY_ENABLED</h3>

<p>Flag for enabling the history API.</p>

<h3>HISTORY_MAX_SIZE</h3>

<p>The maximum size of a user's history. If the value is an integer, this
is the maximum number of allowed items in the user's history. Set to
<code>None</code> (or 0) to enable unlimited history. Note, in order to enforce this
limit, the <code>avocado history --prune</code> command must be executed to remove
the oldest history from each user based on this value.</p>

<h3>METADATA_MIGRATION_APP</h3>

<p>The app that the metadata migrations will be created for. This must be defined
to use the <code>avocado migration</code> command.</p>

<h3>METADATA_FIXTURE_DIR</h3>

<p>The directory where the metadata fixtures will be written to. If not defined,
it will default to the fixtures directory in the app defined by
<code>METADATA_MIGRATION_APP</code>.</p>

<h3>METADATA_FIXTURE_SUFFIX</h3>

<p>The <em>suffix</em> of the metadata fixtures. Default is <code>avocado_metadata</code>.</p>

<h3>METADATA_MIGRATION_SUFFIX</h3>

<p>The <em>suffix</em> of the South migration scripts for migrating the metadata.
Default is <code>avocado_metadata_migration</code>.</p>

<hr><h2>Examples</h2>

<h3>DataContext Condition Trees</h3>

<h4>Single Condition</h4>

<div class="highlight"><pre><span class="p">{</span>
    <span class="s2">"id"</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s2">"operator"</span><span class="o">:</span> <span class="s2">"iexact"</span><span class="p">,</span>
    <span class="s2">"value"</span><span class="o">:</span> <span class="mi">50</span>
<span class="p">}</span>
</pre></div>

<h4>Branch with Two Conditions</h4>

<div class="highlight"><pre><span class="p">{</span>
    <span class="s2">"type"</span><span class="o">:</span> <span class="s2">"and"</span><span class="p">,</span>
    <span class="s2">"children"</span><span class="o">:</span> <span class="p">[{</span>
        <span class="s2">"id"</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s2">"operator"</span><span class="o">:</span> <span class="s2">"iexact"</span><span class="p">,</span>
        <span class="s2">"value"</span><span class="o">:</span> <span class="mi">50</span>
    <span class="p">},</span> <span class="p">{</span>
        <span class="s2">"id"</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">"operator"</span><span class="o">:</span> <span class="s2">"in"</span><span class="p">,</span>
        <span class="s2">"value"</span><span class="o">:</span> <span class="p">[</span><span class="s2">"foo"</span><span class="p">,</span> <span class="s2">"bar"</span><span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<h4>Branch with One Condition and One Branch</h4>

<div class="highlight"><pre><span class="p">{</span>
    <span class="s2">"type"</span><span class="o">:</span> <span class="s2">"or"</span><span class="p">,</span>
    <span class="s2">"children"</span><span class="o">:</span> <span class="p">[{</span>
        <span class="s2">"id"</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s2">"operator"</span><span class="o">:</span> <span class="s2">"iexact"</span><span class="p">,</span>
        <span class="s2">"value"</span><span class="o">:</span> <span class="mi">50</span>
    <span class="p">},</span> <span class="p">{</span>
        <span class="s2">"type"</span><span class="o">:</span> <span class="s2">"and"</span><span class="p">,</span>
        <span class="s2">"children"</span><span class="o">:</span> <span class="p">[{</span>
            <span class="s2">"id"</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">"operator"</span><span class="o">:</span> <span class="s2">"in"</span><span class="p">,</span>
            <span class="s2">"value"</span><span class="o">:</span> <span class="p">[</span><span class="s2">"foo"</span><span class="p">,</span> <span class="s2">"bar"</span><span class="p">]</span>
        <span class="p">},</span> <span class="p">{</span>
            <span class="s2">"id"</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">"operator"</span><span class="o">:</span> <span class="s2">"in"</span><span class="p">,</span>
            <span class="s2">"value"</span><span class="o">:</span> <span class="p">[</span><span class="s2">"baz"</span><span class="p">,</span> <span class="s2">"qux"</span><span class="p">]</span>
        <span class="p">}]</span>
    <span class="p">}]</span>
<span class="p">}</span>
</pre></div>

<h2>Notes</h2>

<h3>Internal vs. Simple Types</h3>

<p>Internal types correspond to the model field's class and are necessary when performing write operations for data intregrity. For query purposes, internal types tend to be too <em>low-level</em> and restrictive during query validation. To provide a less restrictive interface for query validation, Avocado introduces a <em>simple</em> type which merely maps internal types to a higher-level type such as <em>string</em> or <em>number</em>.</p>

<h3>Relationships Are Transparent</h3>

<p>Avocado uses the <a href="https://github.com/cbmi/modeltree">ModelTree</a> API to build in-memory indexes for each model accessed by the application. To build an index, all possible paths from the given <em>root</em> model are traversed and metadata about each relationship is captured. When a query needs to be generated, the lookup string can be generated for a model field relative to the root model.</p>

<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">tree</span> <span class="o">=</span> <span class="n">ModelTree</span><span class="p">(</span><span class="n">Author</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">title</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_field_by_name</span><span class="p">(</span><span class="s">'title'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">tree</span><span class="o">.</span><span class="n">query_string_for_field</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="s">'icontains'</span><span class="p">)</span>
<span class="s">'book__title__icontains'</span>
</pre></div>

<p>This looks a bit clumsy in practice which is why Avocado uses the <code>DataField</code> class to manage all this field-specific <em>stuff</em>.</p>

<p>Having these indexes enables generating queries regardless of the entry point and which fields are being queried or retrieved. This perceivably <em>flattens</em> out the data model from the client's perspective which increases it's accessiblity.</p>

<h2>CHANGELOG</h2>

<p>2.0.17 <a href="https://github.com/cbmi/avocado/compare/2.0.16...2.0.17">diff</a></p>

<ul>
<li>Fix performance in <code>Formatter</code> class due to redundant logging</li>
<li>Add support for <code>Decimal</code> types in <code>Formatter.to_number</code> method</li>
</ul><p>2.0.16 <a href="https://github.com/cbmi/avocado/compare/2.0.15...2.0.16">diff</a></p>

<ul>
<li>Update ModelTree to version 1.1.3 (critical bug fix)</li>
<li>Add receiver for change Avocado settings during test execution</li>
<li>Add missing <code>DataField.coded_values</code> which the <code>Formatter.to_coded</code> relied on</li>
</ul><p>2.0.15 <a href="https://github.com/cbmi/avocado/compare/2.0.14...2.0.15">diff</a></p>

<ul>
<li>Add backup utilities for performing metadata data migrations</li>
<li>New command <code>avocado migration</code> for creating a metadata fixture and a corresponding South migration to load the fixture</li>
<li>Fix bug in R and SAS exporters</li>
<li>Improve <code>ObjectSet</code> class to enable deleting set objects rather than just flagging as being deleted

<ul>
<li>Pass the flag <code>delete=True</code> when calling a remove-based command, e.g. <code>foo.replace(objs, delete=True)</code>
</li>
</ul>
</li>
</ul><p>2.0.14 <a href="https://github.com/cbmi/avocado/compare/2.0.13...2.0.14">diff</a></p>

<ul>
<li>Fix bug that only checked for NumPy for the for SciPy feature</li>
</ul><p>2.0.13 <a href="https://github.com/cbmi/avocado/compare/2.0.12...2.0.13">diff</a></p>

<ul>
<li>Change <code>HTMLFormatter</code> to require the <code>template</code> argument which may be a template name
or a <code>Template</code> object.</li>
<li>Allow arbitrary <code>*args</code> and <code>**kwargs</code> to be passed into <code>*Exporter.write</code> and
<code>*Exporter.read</code> to enable propagation from <code>write</code> to <code>read</code>
</li>
<li>Add <code>short_name</code> and <code>long_name</code> for use downstream by clients</li>
<li>Add <a href="https://github.com/cbmi/avocado/commit/e9865e6631bc62fc63d6cea439dd6d61f4d930d5">export-specific format as the first <em>preferred format</em></a>

<ul>
<li>This is a better default which enables specific formatting when needed. The more general format can be reused across formatters, but when very specific formatting is necessary, this default is preferred.</li>
</ul>
</li>
<li>Refactor <code>DataField.model</code> and <code>DataField.field</code> to take in account <code>Lexicon</code> and <code>ObjectSet</code> models

<ul>
<li>The <em>real</em> field and model instances are now named <code>real_field</code> and <code>real_model</code>, respectively.</li>
</ul>
</li>
<li>Fix #55, <code>Lexicon.label</code> is now correctly used by the <code>DataView</code>
</li>
<li>Rename <code>sync</code> subcommand to <code>init</code>
</li>
<li>Rename <code>SYNC_ENUMERABLE_MAXIMUM</code> to <code>ENUMERABLE_MAXIMUM</code>
</li>
<li>Remove <code>orphaned</code> command in favor of new <code>check</code> that performs multiple setup
checks as well as check for invalid datafields.</li>
<li>Remove <code>searchable</code> model field since this applies only to text-based fields.

<ul>
<li>This has been repurposed as a deprecated computed property</li>
</ul>
</li>
<li>Fix #45, allow dict-based settings to be updated, but not overridden</li>
<li>Remove <code>DataField.data_source</code> field

<ul>
<li>There was no functional utility of this field and is (currently) out of the scope for Avocado</li>
</ul>
</li>
</ul><p>2.0.12 <a href="https://github.com/cbmi/avocado/compare/2.0.11...2.0.12">diff</a></p>

<ul>
<li>Rename <code>SasExporter</code> =&gt; <code>SASExporter</code> for caps consistency</li>
</ul><p>2.0.11 <a href="https://github.com/cbmi/avocado/compare/2.0.10...2.0.11">diff</a></p>

<ul>
<li>Remove assumption of lowercasing the <code>app_name</code> during an init call</li>
</ul><p>2.0.10 <a href="https://github.com/cbmi/avocado/compare/2.0.9...2.0.10">diff</a></p>

<ul>
<li>String formatting cleanup</li>
<li>Add missing avocado/export/models.py file form 2.0.9</li>
<li>Replace <code>DataField.operators</code> with <code>DataField.operator_choices</code>

<ul>
<li>There is no need for two properties where one is a subset of the other</li>
</ul>
</li>
<li>Fix <code>Translator.language</code> to use the cleaned value for model-based values</li>
<li>Simplify exact-based <code>Operator.verbose_name</code> strings</li>
<li>Add CHANGELOG to this README :)</li>
</ul><p>2.0.9 <a href="https://github.com/cbmi/avocado/compare/2.0.8...2.0.9">diff</a></p>

<ul>
<li>Add appropriate <code>content_type</code> and <code>file_extension</code> to Exporter classes</li>
<li>Subclass <code>DjangoJSONDecoder</code> for use in the <code>JSONExporter</code>
</li>
<li>Add <code>validate</code> convenience method to <code>DataContext</code> and <code>DataView</code>
</li>
<li>Rename <code>node</code> to <code>parse</code> on <code>DataContext</code> and <code>DataView</code>
</li>
<li>Add support for <a href="https://github.com/cbmi/avocado/issues/43">handling redundant rows via the exporter API</a>

<ul>
<li>The <code>BaseExporter.read</code> now has a <code>force_distinct</code> argument that can be set to <code>False</code> to prevent removing redundant rows</li>
</ul>
</li>
<li>Add (fix) support for using <code>key</code>-based <code>DataField</code>s</li>
<li>Refacor R and SAS exporter classes to use templates when generating the script</li>
<li>Fix <code>Condition.field</code> property to use <code>get_by_natural_key</code>
</li>
</ul><p>2.0.8 <a href="https://github.com/cbmi/avocado/compare/2.0.7...2.0.8">diff</a></p>

<ul>
<li>
<a href="https://github.com/cbmi/avocado/commit/a7d6e7ca44bb408021c478484721741dbe5351ae">Add <code>DataConcept.sortable</code> field</a>

<ul>
<li>This is purely for informational purposes and does not add a hard constraint when performing ordering by the <code>DataView</code>. Clients can use this field to prevent sorting by unsortable concepts.</li>
</ul>
</li>
</ul><p>2.0.7 <a href="https://github.com/cbmi/avocado/compare/2.0.6...2.0.7">diff</a></p>

<ul>
<li>Implement settings and management command and <a href="https://github.com/cbmi/avocado/issues/41">history API (#41)</a>
</li>
<li>Update ModelTree to 1.1.1, make South a hard dependency</li>
</ul><p>2.0.6 <a href="https://github.com/cbmi/avocado/compare/2.0.5...2.0.6">diff</a></p>

<ul>
<li><a href="https://github.com/cbmi/avocado/commit/eed56830fd2c1639bf2743da29a2dad2eaaadeb4">Abstract out core functionality of DataContext and DataView models</a></li>
<li>Fix bug in <code>legacy</code> command where a trailing comma caused legacy fields names to be set as a tuple</li>
</ul><p>2.0.5 <a href="https://github.com/cbmi/avocado/compare/2.0.4...2.0.5">diff</a></p>

<ul>
<li>Enforce a <code>SELECT DISTINCT</code> by default when calling <code>DataContext.apply</code>

<ul>
<li>A new keyword argument <code>default</code> <a href="https://github.com/cbmi/avocado/commit/f3b7de08ecd94c36bcefaf7cc3b30cefcc09d44b">has been added</a> to override this behavior</li>
</ul>
</li>
<li>Wrap <code>orphaned</code> command in transaction in case <code>--unpublish</code> is used to prevent inconsistent unpublishing</li>
<li><a href="https://github.com/cbmi/avocado/commit/e7686081537f44631703c7638ab06ca1bf401719">Add support for <code>isnull</code> lookups</a></li>
</ul><p>2.0.4 <a href="https://github.com/cbmi/avocado/compare/2.0.3...2.0.4">diff</a></p>

<ul>
<li>Add Python 2.6 classifier</li>
<li>Fix incorrect use of <code>sys.version_info</code>
</li>
</ul><p>2.0.3 <a href="https://github.com/cbmi/avocado/compare/2.0.2...2.0.3">diff</a></p>

<ul>
<li>Add Python 2.6 support</li>
</ul><p>2.0.2 <a href="https://github.com/cbmi/avocado/compare/2.0.1...2.0.2">diff</a></p>

<ul>
<li>Change django-jsonfield dependency link to cbmi fork</li>
</ul><p>2.0.1 <a href="https://github.com/cbmi/avocado/compare/2.0.0...2.0.1">diff</a></p>

<ul>
<li>Fix setup.py classifiers</li>
<li>Fix django-jsonfield dependency link</li>
</ul><p>2.0.0 - Initial release</p>
      </section>
      <footer>
        <p><small>Hosted on <a href="https://pages.github.com">GitHub Pages</a> using the Dinky theme</small></p>
      </footer>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
		          <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-30792817-2");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>